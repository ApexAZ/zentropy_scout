name: Dependency Audit

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pip-audit:
    name: pip-audit (Python Dependencies)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e "./backend[dev]"

      - name: Install pip-audit
        run: python -m pip install pip-audit

      - name: Run pip-audit (with retry)
        run: |
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "::group::Attempt $attempt of $max_attempts"
            if pip-audit --vulnerability-service osv; then
              echo "::endgroup::"
              echo "pip-audit passed on attempt $attempt"
              exit 0
            fi
            exit_code=$?
            echo "::endgroup::"
            if [ $attempt -lt $max_attempts ]; then
              echo "::warning::pip-audit failed (attempt $attempt/$max_attempts), retrying in 30s..."
              sleep 30
            fi
            attempt=$((attempt + 1))
          done
          echo "::error::pip-audit failed after $max_attempts attempts"
          exit 1

  npm-audit:
    name: npm audit (Node.js Dependencies)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6

      - name: Set up Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: cd frontend && npm ci

      - name: Run npm audit (with retry)
        run: |
          # Temporarily accepted advisories (dev-only, no upstream fix available).
          # These are checked via npm audit --json and filtered out. Any NEW
          # advisory will still fail CI. Remove entries when upstream fixes land.
          #
          # GHSA-2g4f-4pwh-qvx6: ajv ReDoS (moderate, dev-only)
          #   - ESLint pins ajv@6.x; fix only in ajv@8.18.0+
          #   - ESLint team declined to upgrade (github.com/eslint/eslint/issues/18947)
          #   - Accepted 2026-02-17, zero production risk (linter config input only)
          #
          # GHSA-23c5-xmqv-rm74: minimatch ReDoS — nested *() extglobs (high, dev-only)
          # GHSA-7r86-cg39-jmmj: minimatch ReDoS — GLOBSTAR backtracking (high, dev-only)
          #   - Transitive dep of eslint, eslint-config-next, eslint-plugin-jsx-a11y, shadcn
          #   - All are devDependencies; minimatch not imported by any production code
          #   - ReDoS requires attacker-controlled glob patterns; all patterns from config files
          #   - Accepted 2026-02-26, zero production risk
          #
          ACCEPTED_ADVISORIES="GHSA-2g4f-4pwh-qvx6 GHSA-23c5-xmqv-rm74 GHSA-7r86-cg39-jmmj"

          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "::group::Attempt $attempt of $max_attempts"
            audit_json=$(cd frontend && npm audit --json --audit-level=moderate 2>/dev/null) || true
            # Extract unique advisory URLs from findings
            found=$(echo "$audit_json" | jq -r '
              [.vulnerabilities // {} | to_entries[] | .value.via[]
               | select(type == "object") | .url // empty] | unique | .[]
            ' 2>/dev/null) || found=""
            # Filter out accepted advisories
            unexpected=""
            for url in $found; do
              is_accepted=false
              for ghsa in $ACCEPTED_ADVISORIES; do
                if echo "$url" | grep -q "$ghsa"; then
                  is_accepted=true
                  break
                fi
              done
              if [ "$is_accepted" = false ]; then
                unexpected="$unexpected $url"
              fi
            done
            if [ -z "$unexpected" ]; then
              echo "::endgroup::"
              if [ -n "$found" ]; then
                echo "::notice::npm audit passed (accepted advisories only: $ACCEPTED_ADVISORIES)"
              else
                echo "npm audit passed on attempt $attempt"
              fi
              exit 0
            fi
            echo "::endgroup::"
            if [ $attempt -lt $max_attempts ]; then
              echo "::warning::npm audit found unexpected vulnerabilities (attempt $attempt/$max_attempts), retrying in 30s..."
              sleep 30
            fi
            attempt=$((attempt + 1))
          done
          echo "::error::npm audit found unexpected vulnerabilities:$unexpected"
          cd frontend && npm audit --audit-level=moderate
          exit 1
