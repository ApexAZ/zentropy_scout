name: Dependency Audit

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pip-audit:
    name: pip-audit (Python Dependencies)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e "./backend[dev]"

      - name: Install pip-audit
        run: python -m pip install pip-audit

      - name: Run pip-audit (with retry)
        run: |
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "::group::Attempt $attempt of $max_attempts"
            if pip-audit --vulnerability-service osv; then
              echo "::endgroup::"
              echo "pip-audit passed on attempt $attempt"
              exit 0
            fi
            exit_code=$?
            echo "::endgroup::"
            if [ $attempt -lt $max_attempts ]; then
              echo "::warning::pip-audit failed (attempt $attempt/$max_attempts), retrying in 30s..."
              sleep 30
            fi
            attempt=$((attempt + 1))
          done
          echo "::error::pip-audit failed after $max_attempts attempts"
          exit 1
