# Zentropy Scout — Environment Setup

Instructions for setting up a new development machine after cloning the repo.

---

## Prerequisites

Install these once on the machine:

| Tool | Install Command | Purpose |
|------|-----------------|---------|
| **Python 3.11+** | `sudo apt install python3.11 python3.11-venv` (or use pyenv) | Runtime |
| **Docker Desktop** | [docs.docker.com/desktop](https://docs.docker.com/get-started/get-docker/) — enable WSL integration if using WSL | PostgreSQL + pgvector |
| **git** | Usually pre-installed | Version control |
| **Claude Code** | `npm install -g @anthropic-ai/claude-code` | AI coding assistant CLI |
| **gitleaks** | `brew install gitleaks` or download from [releases](https://github.com/gitleaks/gitleaks/releases) | Pre-commit secret detection |
| **libmagic** | `sudo apt install libmagic1` | Required by python-magic (file content validation) |
| **GitHub CLI (gh)** | See [cli.github.com](https://cli.github.com/) — add apt repo, then `sudo apt install gh` | GitHub Actions, PRs, workflow triggers |
| **Node.js / npm** | `sudo apt install nodejs npm` (or use nvm) | Required for Claude Code install |

---

## Setup Steps

### 1. Clone the repo

```bash
git clone git@github.com:ApexAZ/zentropy_scout.git
cd zentropy_scout
```

### 2. Environment file

```bash
cp .env.example .env
```

The `.env` ships with safe defaults for local development:
- Database credentials are the dev defaults (matching `docker-compose.yml`)
- API keys are placeholders — replace with real keys when needed
- No real secrets exist in `.env.example`

Edit `.env` if you need to set:
- `OPENAI_API_KEY` — required for embeddings (scoring engine)
- `ANTHROPIC_API_KEY` — required for hosted LLM mode (not needed for local mode)
- `DEFAULT_USER_ID` — your user UUID for local-first auth bypass

### 3. Python virtual environment and dependencies

```bash
cd backend
python3.11 -m venv .venv
source .venv/bin/activate
pip install -e ".[dev]"
```

This installs all runtime and dev dependencies defined in `backend/pyproject.toml`:
- **Runtime:** FastAPI, SQLAlchemy, ReportLab, LangGraph, Anthropic/OpenAI SDKs, etc.
- **Dev:** pytest, ruff, bandit, pre-commit, mypy, etc.

### 4. Pre-commit hooks

```bash
cd ..  # back to repo root
pre-commit install --hook-type pre-commit --hook-type pre-push
```

This enables:
- **On commit:** ruff lint/format, bandit security scan, gitleaks secret detection, trailing whitespace, etc.
- **On push:** Full pytest suite (all 3,500+ tests must pass)

### 5. Start PostgreSQL

```bash
docker compose up -d
```

Wait for healthy status:

```bash
docker compose ps
# Should show: zentropy_scout_db ... Up (healthy)
```

### 6. Create test database and run migrations

```bash
# Create the test database (used by pytest)
docker compose exec postgres createdb -U zentropy_user zentropy_scout_test
docker compose exec postgres psql -U zentropy_user -d zentropy_scout_test \
  -c "CREATE EXTENSION IF NOT EXISTS vector;"

# Run migrations on the main database
cd backend
.venv/bin/alembic upgrade head
```

### 7. Verify everything works

```bash
# Run the full test suite
.venv/bin/pytest tests/ -v

# Run linters
.venv/bin/ruff check app/
.venv/bin/bandit -r app/ -c pyproject.toml
```

Expected: 3,576+ tests passing, no lint errors.

---

## What You Get from the Clone

The repo includes Claude Code project configuration:

| Path | Content |
|------|---------|
| `CLAUDE.md` | Project memory, conventions, learned lessons, session checklist |
| `.claude/settings.json` | Hooks (requirement doc protection, ruff auto-format, commit reminder) and shared permissions |
| `.claude/agents/` | 5 subagents: code-reviewer, security-reviewer, req-reader, test-runner, security-references |
| `.claude/skills/` | 16 skills: zentropy-planner, zentropy-tdd, zentropy-db, zentropy-api, etc. |

### Built automatically on first use

| Path | How |
|------|-----|
| `.claude/settings.local.json` | Created as you approve tool permissions ("Allow always" prompts) |
| `CLAUDE_TOOLS.md` | Auto-generated by Claude Code |

---

## CI Security Tooling

The repo includes GitHub Actions workflows for security scanning. Most work automatically, but Semgrep requires a one-time setup.

### Semgrep Team (requires setup)

Semgrep provides cross-file taint analysis with FastAPI-native detection. Free for ≤10 contributors.

1. Sign up at [semgrep.dev](https://semgrep.dev) (use "Sign in with GitHub")
2. Add your repo to the Semgrep dashboard
3. Go to **Settings → Tokens** and copy your `SEMGREP_APP_TOKEN`
4. In your GitHub repo: **Settings → Secrets and variables → Actions → New repository secret**
   - Name: `SEMGREP_APP_TOKEN`
   - Value: paste the token

### Dependabot (automatic)

Already configured in `.github/dependabot.yml`. Scans pip and GitHub Actions dependencies weekly. No setup needed — GitHub enables it automatically when the config file is present.

### pip-audit (automatic)

Runs on every push/PR via `.github/workflows/pip-audit.yml`. Scans Python dependencies against Google's OSV database. No setup needed.

### SonarCloud (requires setup)

If you want SonarCloud analysis on your fork/clone:

1. Sign up at [sonarcloud.io](https://sonarcloud.io) (use "Sign in with GitHub")
2. Import your repo
3. In your GitHub repo: **Settings → Secrets and variables → Actions → New repository secret**
   - Name: `SONAR_TOKEN`
   - Value: paste the token from SonarCloud

---

## Troubleshooting

### Tests fail with connection errors
Docker/PostgreSQL may not be running. Check with `docker compose ps` and start with `docker compose up -d`.

### `python3.11: command not found`
Install Python 3.11 or use pyenv: `pyenv install 3.11` then `pyenv local 3.11`.

### `gitleaks` not found during pre-commit
Install gitleaks separately — it's not a Python package. See the prerequisites table above.

### `libmagic` / `magic` import errors
Install the system library: `sudo apt install libmagic1`.
